<!DOCTYPE html>
<html>
<body>
<h3>UNPACK_SKIP_PIXELS Visual PoC</h3>
<canvas id="c" width="2" height="2"></canvas>
<pre id="log"></pre>

<script>
const log = m => document.getElementById("log").textContent += m + "\n";

const canvas = document.getElementById("c");
const gl = canvas.getContext("webgl");

if (!gl) {
  log("WebGL not supported");
  throw 0;
}

log("WebGL OK");

// 4x4 texture = 16 pixels
const tex = gl.createTexture();
gl.bindTexture(gl.TEXTURE_2D, tex);

gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);

// Fill pattern: R,G,B,A increasing
const data = new Uint8Array(16 * 4);
for (let i = 0; i < 16; i++) {
  data[i*4+0] = i * 16; // R
  data[i*4+1] = 0;
  data[i*4+2] = 0;
  data[i*4+3] = 255;
}

gl.pixelStorei(gl.UNPACK_ALIGNMENT, 1);
gl.pixelStorei(gl.UNPACK_ROW_LENGTH, 4);
gl.pixelStorei(gl.UNPACK_SKIP_ROWS, 0);

// ⚠️ قيمة مشبوهة لكن ليست قصوى
gl.pixelStorei(gl.UNPACK_SKIP_PIXELS, 7);

gl.texImage2D(
  gl.TEXTURE_2D,
  0,
  gl.RGBA,
  2,
  2,
  0,
  gl.RGBA,
  gl.UNSIGNED_BYTE,
  data
);

// draw
const vs = gl.createShader(gl.VERTEX_SHADER);
gl.shaderSource(vs, `
attribute vec2 p;
varying vec2 v;
void main() {
  v = (p + 1.0) * 0.5;
  gl_Position = vec4(p, 0, 1);
}`);
gl.compileShader(vs);

const fs = gl.createShader(gl.FRAGMENT_SHADER);
gl.shaderSource(fs, `
precision mediump float;
varying vec2 v;
uniform sampler2D t;
void main() {
  gl_FragColor = texture2D(t, v);
}`);
gl.compileShader(fs);

const prog = gl.createProgram();
gl.attachShader(prog, vs);
gl.attachShader(prog, fs);
gl.linkProgram(prog);
gl.useProgram(prog);

const buf = gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER, buf);
gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
  -1,-1, 1,-1, -1,1, 1,1
]), gl.STATIC_DRAW);

const loc = gl.getAttribLocation(prog, "p");
gl.enableVertexAttribArray(loc);
gl.vertexAttribPointer(loc, 2, gl.FLOAT, false, 0, 0);

gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);

log("If math is sane → predictable red shade");
log("If math is off → unexpected color / black");
</script>
</body>
</html>
